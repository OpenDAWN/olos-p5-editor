<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../olos-code-editor/olos-code-editor.html">

<!--
olos-analyser-p5
##### Example


@element olos-analyser-p5
@blurb 
@status alpha
@homepage 
-->
<polymer-element name="olos-analyser-p5" attributes="setupFunction drawFunction">

  <template>

    <link rel="stylesheet" href="olos-analyser-p5.css">
    <script src="p5.js"></script>

    <olos-code-editor id="setup">{{setupFunction}}</olos-code-editor>
    <olos-code-editor id="draw">{{drawFunction}}</olos-code-editor>


<!--     <textarea value="{{setupFunction}}" id="setup"></textarea>
    <textarea value="{{drawFunction}}" id="draw"></textarea>
 -->
    <div id="canvas_container"></div>

  </template>

</polymer-element>
<script>

  function findSyntaxError( code ) {
      var error = [];
      var save_onerror = onerror;
      onerror = function(errorMsg, url, lineNumber) {
         error = [lineNumber, errorMsg.replace("Uncaught ","")];
      }
      var element = document.createElement('script');
      element.appendChild(document.createTextNode( code ));
      document.body.appendChild(element);
      onerror = save_onerror;
      return error;
   }

  function evalCode(code) {
    var tempFunc = new Function('with (this) {'+code+'}');

    try {
      eval(tempFunc);
    } catch(e) {
      console.log(e.message);
      return false
    }
      return true;
  }

  function refErrorCheck(code) {

    var isAlpha = function(c) { return c >= 'a' && c <= 'z'; };

    // // REMOVE EVERYTHING BUT SPACE-SEPARATED VARIABLE NAMES AND '(' CHARACTERS.
    // var words = code.split(/[\s\n,; ]/g);
    // for (var i = 0; i < words.length; i++) {
    //   if ( (words[i].indexOf('(') === -1) && (words[i].indexOf(')') === -1) ) {
    //     console.log(words[i] + ' fails.');
    //   } else {
    //     console.log(words[i] + ' passes!');
    //   }
    // }

    var str = code.replace(/[^a-zA-Z_(]/g,' ').replace(/ +/g,' ').replace(/ \(/g,'(');
    console.log(str);
    for (var i = 0; i < str.length; i++) {
      if (isAlpha(str.charAt(i))) {
        // IF WE FIND A FUNCTION NAME NOT FOLLOWED BY A '(', THEN THIS CODE IS UNPARSABLE.
        var j = i + 1;
        for (; j < str.length && isAlpha(str.charAt(j)); j++)
          ;
          try {
            if ( typeof eval(str.substring(i, j)) === 'function' && str.charAt(j) != '(' )
              return false;
            }
          catch(e) {}
          i = j;
      }
    }
    return true;
  }


  Polymer('olos-analyser-p5', {
    scope: this,

    // thank you https://github.com/sepans/p5-element/master/p5-element.html
    _p5: null,
    _sketch: {},
    setupFunction: 'createCanvas(300, 200);\nbackground(255); \nrect(10,10,10,10);',
    drawFunction: 'background(255,255,0);',
    globalVars: '',

    // store p5 instances in an array so we can delete the ones we dont want
    _p5Array: [],

    observe: {
      // setupFunction: '_setupFunctionChanged',
      // drawFunction: '_drawFunctionChanged',
      // setupErr: 'setupErrChanged',
      // drawErr: 'drawErrChanged'
    },

    ready: function() {
      var self = this;
      self.$.setup.codeChanged(this._setupChanged.bind(this));
      self.$.draw.codeChanged(this._drawChanged.bind(this));
      self._createP5();
    },

    _createP5: function() {
      var self = this, setupFunc = null, drawFunc = null;
      try {
        setupFunc = new Function('with (this) {'+self.setupFunction+'}');
      }
      catch(e) {
        self.setupErr = e.message; // and line #?
        throw('setup error: ' + e.message);
        self._cleanUp();
        return;
      }
      self.setupErr = '';

      try {
        drawFunc = new Function('with (this) {'+self.drawFunction+'}');
      }
      catch(e) {
        self.drawErr = e.message; // and line #?
        throw('draw error: ' + e.message);
        self._cleanUp();
        return;
      }
      self.drawErr = '';

      // console.log(findSyntaxError(setupFunc));
      // console.log(findSyntaxError(drawFunc));

      self._sketch = function(sketch) {
        sketch.setup = setupFunc.bind(sketch);
        sketch.draw = drawFunc.bind(sketch);
      }

      self._cleanUp();

      try {
        // make a new p5 sketch
        self._p5 = new p5(self._sketch, self.$.canvas_container); 

        // add this to the top of the array
        self._p5Array.push(self._p5);
        console.log('new sketch');
      }
      catch(e) {
        console.log('error deleting p5');
        console.log(e.message);
        self.drawErr = e.message;// + ' ' + e.lineNumber;
        self._cleanUp();
        // self._p5.noLoop();
        // if (self._p5) {
        //   self._p5.remove();
        // }
        // remove all the sketches in the p5 array
        // for (var i = 0; i < self._p5Array.length - 2; i++) {
        //   self._p5Array[i].remove();
        //   self._p5Array.pop();
        // }
        delete self._sketch;
        return;
      }
    },

    _cleanUp: function() {
      var self = this;
      console.log('num arrays: ' + self._p5Array.length);
      // remove all the existing sketches in the p5 array
      for (var i = 0; i < self._p5Array.length; i++) {
        self._p5Array[i].remove();
        // self._p5Array.pop();
      }
    },

    // callbacks from olos-code-editor / codemirror
    _setupChanged: function(f) {
      var self = this;
      console.log(f);
      self.setupFunction = f;
      self._createP5();
    },

    // callbacks from olos-code-editor / codemirror
    _drawChanged: function(f) {
      var self = this;
      self.drawFunction = f;
      self._createP5();
    },

    _globalVarsChanged: function() {
      var self = this;
      self._globalVarsParsed = [];
      var varList = self.globalVars.split(',');
      self._globalVarsParsed = varList.map(function(item) {
        var splits = item.split('=');
        var value = splits.length>1 ? splits[1] : null;
        var parsedValue = (!isNaN(parseFloat(value)) && isFinite(value)) ? parseFloat(value) : value;
        return {
          name: splits[0].trim(),
          value: parsedValue
        }
      });
      self._createP5();
    },

    setupErrChanged: function(e) {
      console.log('setup error: ' + e);
    },

    drawErrChanged: function(e) {
      console.log('draw error: ' + e);
    },

  });

</script>